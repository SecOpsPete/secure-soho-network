# 🛡️ Isolated USB Malware Checking & Imaging Station (Raspberry Pi)

I built this Raspberry Pi–based station to **safely check USB media for malware** before those devices ever touch my main systems. The station lives on an **isolated/guest VLAN** with strict egress rules and stores results on an attached SSD. The day-to-day goal is simple: **malware screening only**. If anything looks suspicious, I escalate to a forensics workflow (full image + hash + offline analysis on a beefier workstation with Autopsy). This README documents the **why** for each step, not just the commands, so the process is repeatable and defensible.

## 🎯 Objectives
- **Contain risk**: mount external media read-only with non-exec flags; never run file content.  
- **Detect quickly**: use ClamAV signature scans with persistent logs.  
- **Decide cleanly**: if **CLEAN**, unmount and reuse; if **FOUND**, freeze evidence and escalate.  
- **Document**: keep hashes, logs, and chain-of-custody notes alongside artifacts.  

## 🧱 Threat Model & Design Principles
- **Assume untrusted media is hostile.** Autorun, hidden LNKs, polyglot files, and malicious macros are common.  
- **No execution path.** I never “open” files from the USB on the Pi; the device is mounted `ro,nosuid,nodev,noexec` to remove write, SUID, device, and exec paths.  
- **Hash-first evidence handling.** If malware is found, I image the **entire device** (not just files) to capture slack space, deleted items, and metadata, then hash it.  
- **Isolated transfer.** I move **images, not executables**, to an analysis box. Copying bytes is not execution; I still keep the analysis host offline or in a lab VLAN and disable autoplay.  

## 🧰 Prerequisites
- Raspberry Pi (64-bit OS), on **guest/isolated VLAN** (egress limited to DNS/HTTPS for updates).  
- External SSD attached as the working volume (mounted at `/mnt/PiSSD`).  
- Packages: `clamav`, `clamav-freshclam`, `ntfs-3g`, `exfat-fuse`, `exfatprogs`.  

Install once:  
`sudo apt update`  
`sudo apt install -y clamav clamav-freshclam ntfs-3g exfat-fuse exfatprogs`

## 📦 Mount the Working SSD
Why: the SSD holds logs, images, and analysis output so the Pi’s microSD isn’t worn out and has space for large images.

1. Identify the SSD device: `lsblk`  
2. Mount it:  
   `sudo mkdir -p /mnt/PiSSD`  
   `sudo mount /dev/sda1 /mnt/PiSSD`  
3. Create working directories:  
   `sudo mkdir -p /mnt/PiSSD/{logs,images,manifests,work/usb1_analysis,work/usb2_analysis}`

## 🔍 Scan-Only SOP (fast “is it safe?” flow)
**Why these flags:**  
- `ro` = no writes to suspect media.  
- `noexec` = binaries on the USB can’t execute.  
- `nosuid,nodev` = remove other escalation paths.  
- Separate folders keep results isolated.

1. **Identify the USB**  
   Run: `lsblk`  
   Example: USB shows up as `/dev/sdb`.  
   > **Watch out:** Easy to confuse disks. Always verify size/label so you don’t accidentally scan or image the wrong device.

2. **Mount Read-Only**  
   `sudo mount -o ro,nosuid,nodev,noexec /dev/sdb1 /mnt/PiSSD/work/usb1_analysis`  
   > Skipping `noexec` leaves a window where double-clicking could launch something. Always combine `ro` with `nosuid,nodev,noexec`.

3. **Update AV Signatures**  
   `sudo systemctl stop clamav-freshclam`  
   `sudo freshclam`  
   `sudo systemctl start clamav-freshclam`  
   > This avoids lock errors and ensures you’re scanning with the latest signatures.

4. **Scan the USB**  
   `timestamp=$(date -u +"%Y-%m-%d_%H-%M-%S")`  
   `sudo clamscan -r /mnt/PiSSD/work/usb1_analysis | tee "/mnt/PiSSD/logs/scan-usb1-${timestamp}.log"`  
   > **Note:** `clamscan *` only checks the current directory. Always use `-r` with a path to catch everything.

5. **Clean Unmount**  
   `sudo umount /mnt/PiSSD/work/usb1_analysis`  
   > **Note::** Never just yank the stick. Even read-only mounts can corrupt metadata if not unmounted properly.

6. **Loop Device Cleanup**  
   `sudo losetup -a` then `sudo losetup -d /dev/loopX` if needed.  
   > **Interesting:** Loop devices are kernel helpers, not the USB itself. If they linger, they can block future mounts.

7. **Repeat for usb2 (example /dev/sdc1)**  
   `sudo mount -o ro,nosuid,nodev,noexec /dev/sdc1 /mnt/PiSSD/work/usb2_analysis`  
   `timestamp=$(date -u +"%Y-%m-%d_%H-%M-%S")`  
   `sudo clamscan -r /mnt/PiSSD/work/usb2_analysis | tee "/mnt/PiSSD/logs/scan-usb2-${timestamp}.log"`  
   `sudo umount /mnt/PiSSD/work/usb2_analysis`

## 🧪 Forensic Path (when malware is found)
If the scan reports suspicious or infected files, the workflow shifts from **quick screening** to **full evidence handling**.

1. **Image the device**  
   `usb=/dev/sdb`  
   `img="/mnt/PiSSD/images/usb1-$(date -u +"%Y-%m-%d_%H-%M-%S").raw"`  
   `sudo dd if="${usb}" of="${img}" bs=4M status=progress conv=sync,noerror`  
   `sync`  
   > **Watch out:** Always capture the *entire device* (`/dev/sdb`), not just a partition. This preserves partition tables, deleted files, and slack space.

2. **Hash the image**  
   `sha256sum "${img}" | tee "/mnt/PiSSD/manifests/$(basename ${img}).sha256.txt"`  
   > This ensures integrity and gives you a verifiable reference when moving the image later.

3. **Transfer the SSD to an analysis workstation**  
   At this point the image and manifest already live on the Pi’s SSD. Simply unmount the SSD from the Pi, plug it into the analysis workstation, and re-check the hash. Matching hashes confirm nothing changed.  
   > **Why safe:** A `.raw` image is inert. Copying or hashing doesn’t execute malware. Forensic tools like Autopsy parse it as structured data. Risk only appears if you extract and run suspicious files — which must be done in a sandbox or lab VM, never on a main system.

4. **Analyze with Autopsy**  
   Open Autopsy → New Case → Add Data Source → “Disk Image or VM File” → select the `.raw` file. Autopsy will ingest file systems, directories, and metadata for safe review.

## 🧼 Remediation & Reuse of USB
- If you need to reuse the USB: wipe and reformat fully (not quick format).  
- If treating it as evidence: leave it untouched, paired with image + hash manifest.

## ✅ Clean Exit Checklist
- Scan log shows `Infected files: 0`.  
- USB unmounted cleanly.  
- No leftover loop devices.  
- Stick removed safely.  

The drive is now cleared for use.

## 🚩 Malware Found Checklist
1. Stop — do not open files.  
2. Image the device.  
3. Hash the image.  
4. Record logs and manifest.  
5. Transfer SSD to analysis machine.  
6. Verify hash.  
7. Analyze in Autopsy.  
8. Decide: keep as evidence or destroy.  

## 🧠 Notes & Lessons Learned
- **Loop devices** looked like “converted” USBs at first — they’re not. They must be detached manually.  
- **Unmount before removal** — even with `ro`, pulling sticks can cause corruption.  
- **`*` in clamscan** — misleading; it doesn’t recurse. Always use `-r` with paths.  
- **Freshclam lock** — background daemon can block updates. Stopping and restarting it fixed the issue.  
- **Scope discipline** — Pi station is for malware screening only. Forensic deep dives happen only if malware is found.  

---
## 🧠 Author

**SecOpsPete**  
[GitHub](https://github.com/SecOpsPete) | Cybersecurity Analyst in training | Network Defense | Threat Hunting | Home Lab Projects
